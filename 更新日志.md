# 更新日志

## v1.2.0 - 2025-11-07

### 🎯 新增功能

#### 链接有效性验证

- **自动验证**: 在更新 config.yaml 前验证每个订阅链接是否可访问
- **智能过滤**: 自动过滤掉无效、超时、无法访问的链接
- **详细反馈**: 显示每个链接的验证状态和失败原因
- **可配置**: 通过 `VALIDATE_LINKS` 开关控制是否启用验证
- **超时控制**: 通过 `LINK_VALIDATION_TIMEOUT` 自定义验证超时时间

### ⚙️ 新增配置项

```env
# 是否验证链接有效性 (true/false)
VALIDATE_LINKS=false

# 链接验证超时时间 (毫秒)
LINK_VALIDATION_TIMEOUT=10000
```

### 📊 验证输出示例

```
🔐 链接验证已启用

🔍 开始验证 50 个链接...
   超时设置: 10 秒

[1/50] 验证: https://raw.githubusercontent.com/...
   ✅ 有效

[2/50] 验证: https://example.com/sub/v2ray...
   ⏱️  超时

[3/50] 验证: https://invalid.com/...
   🔍 域名无法解析

📊 验证完成:
   ✅ 有效链接: 35 个
   ❌ 无效链接: 15 个
   📈 有效率: 70.0%
```

### 🔧 技术实现

1. **LinkValidator 类**: 专门的链接验证模块
2. **HTTP 请求**: 使用 axios 进行 GET 请求验证
3. **错误分类**: 区分超时、DNS错误、连接拒绝等不同失败原因
4. **流程集成**: 在保存到 config.yaml 前自动验证

### 💡 使用建议

#### 首次运行 (不建议验证)

```env
VALIDATE_LINKS=false
```

首次运行时收集尽可能多的链接,不进行验证。

#### 日常使用 (推荐验证)

```env
VALIDATE_LINKS=true
LINK_VALIDATION_TIMEOUT=10000
```

定期运行时启用验证,确保只保留有效链接。

#### 快速验证

```env
VALIDATE_LINKS=true
LINK_VALIDATION_TIMEOUT=5000
```

缩短超时时间,快速过滤无响应的链接。

---

## v1.1.0 - 2025-11-07

### 🎯 新增功能

#### 1. 智能排序算法

- **综合评分**: star 数量(70%) + 更新时间(30%)
- **归一化处理**: Min-Max 归一化确保公平比较
- **优先高质量**: 自动选择 star 多且活跃的仓库

#### 2. 多级质量过滤

- **Star 过滤**: 设置最低 star 数量 (`MIN_STARS`)
- **时间过滤**: 设置最大更新天数 (`MAX_DAYS_SINCE_UPDATE`)
- **三级筛选**: API搜索 → Star过滤 → 时间过滤 → 综合排序

#### 3. 保留 YAML 注释

- **智能更新**: 更新 `sub-urls` 时保留所有注释
- **保护示例**: 不删除注释掉的示例链接
- **格式保持**: 维持原有的 YAML 格式

### ⚙️ 新增配置项

```env
# 最低 star 数量 (0 表示不限制)
MIN_STARS=0

# 最大更新天数 (超过此天数未更新的仓库将被忽略)
MAX_DAYS_SINCE_UPDATE=90
```

### 📊 输出改进

运行时显示详细的过滤信息:

```
🔍 搜索关键字: free v2ray
   最低 star: 5
   最大更新天数: 60 天
✅ 初步找到 100 个仓库
   ⭐ 过滤 star < 5: 100 → 75
   📅 过滤超过 60 天未更新: 75 → 50 (过滤了 25 个)
🎯 最终选择 30 个仓库
```

### 🔧 技术优化

1. **性能提升**: 获取 3 倍数量候选仓库,确保过滤后有足够结果
2. **算法优化**: 先过滤后排序,减少计算量
3. **代码重构**: 改进 `config-updater.ts` 的注释保留逻辑

### 📚 新增文档

- [智能排序说明.md](智能排序说明.md) - 详细的算法说明
- [更新日志.md](更新日志.md) - 版本更新记录

### 🐛 Bug 修复

- 修复 YAML 更新时会删除注释的问题
- 修复无效 GitHub Token 导致 401 错误的问题
- 改进错误处理和日志输出

---

## v1.0.0 - 2025-11-07 (初始版本)

### ✨ 核心功能

1. **自动搜索**: 从 GitHub 搜索 V2Ray/Clash 订阅链接
2. **智能解析**: 从 README 提取订阅链接
3. **自动去重**: 基于 URL 的去重机制
4. **分类整理**: 按类型分类(V2Ray/Clash/SS)
5. **定时执行**: 支持 cron 定时任务
6. **双重输出**:
   - Markdown 文件 (完整汇总)
   - config.yaml 自动更新

### 🏗️ 架构设计

遵循 SOLID 原则:

- **GitHubSearcher**: GitHub API 交互
- **ReadmeParser**: README 解析
- **LinkAggregator**: 链接聚合和去重
- **ConfigUpdater**: YAML 配置更新
- **SubscriptionCollector**: 流程协调
- **TaskScheduler**: 任务调度

### 📦 依赖库

- `@octokit/rest` - GitHub API 客户端
- `js-yaml` - YAML 解析
- `node-schedule` - 定时任务
- `dotenv` - 环境变量管理

---

## 使用建议

### 首次运行

```env
MIN_STARS=0
MAX_DAYS_SINCE_UPDATE=90
```

### 日常使用 (推荐)

```env
MIN_STARS=5
MAX_DAYS_SINCE_UPDATE=60
```

### 追求质量

```env
MIN_STARS=10
MAX_DAYS_SINCE_UPDATE=30
```
