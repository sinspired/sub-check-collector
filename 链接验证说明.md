# 链接验证功能说明

## 🎯 功能概述

链接验证功能可以在更新 config.yaml 之前,自动检测每个订阅链接是否可访问,过滤掉无效链接,确保配置文件中只包含可用的订阅源。

## ⚙️ 配置选项

### VALIDATE_LINKS

**类型**: `boolean` (true/false)
**默认值**: `false`
**说明**: 控制是否启用链接验证功能

```env
# 启用验证
VALIDATE_LINKS=true

# 禁用验证
VALIDATE_LINKS=false
```

### LINK_VALIDATION_TIMEOUT

**类型**: `number` (毫秒)
**默认值**: `10000` (10秒)
**说明**: 每个链接的验证超时时间

```env
# 10秒超时
LINK_VALIDATION_TIMEOUT=10000

# 5秒超时(快速验证)
LINK_VALIDATION_TIMEOUT=5000

# 20秒超时(宽松验证)
LINK_VALIDATION_TIMEOUT=20000
```

### LINK_VALIDATION_CONCURRENCY

**类型**: `number`
**默认值**: `10`
**说明**: 并发验证的链接数量,控制同时验证多少个链接

```env
# 并发数 10 (默认,适合大多数情况)
LINK_VALIDATION_CONCURRENCY=10

# 并发数 5 (较保守,适合网络不稳定)
LINK_VALIDATION_CONCURRENCY=5

# 并发数 20 (激进,验证更快但可能触发限流)
LINK_VALIDATION_CONCURRENCY=20

# 并发数 1 (串行验证,最慢但最稳定)
LINK_VALIDATION_CONCURRENCY=1
```

**建议值**:

- **网络稳定**: 10-20
- **网络一般**: 5-10
- **网络不稳定**: 1-5
- **避免限流**: 5 以下

## 🔍 验证流程

```
收集订阅链接
    ↓
保存到 Markdown 文件
    ↓
【是否启用验证?】
    ├─ 是 → 并发验证链接 → 过滤无效链接
    └─ 否 → 直接使用所有链接
    ↓
更新 config.yaml
```

### 并发验证流程

```
总链接数: N
并发数: C

批次1: 验证 链接 1-C     (并发执行)
       ↓
批次2: 验证 链接 C+1-2C  (并发执行)
       ↓
批次3: 验证 链接 2C+1-3C (并发执行)
       ↓
...
       ↓
统计结果并输出
```

## 📊 验证结果类型

### ✅ 有效链接

- HTTP 状态码 2xx-3xx
- 返回了内容
- 在超时时间内响应

### ❌ 无效链接

验证失败的链接会显示具体失败原因:

| 图标 | 原因 | 说明 |
|-----|------|------|
| ⏱️ | 超时 | 请求超过设定的超时时间 |
| 🔍 | 域名无法解析 | DNS 解析失败,域名不存在 |
| 🚫 | 连接被拒绝 | 服务器拒绝连接 |
| ❌ | HTTP 错误 | 返回 4xx/5xx 状态码 |
| ⚠️ | 其他错误 | 其他网络或请求错误 |

## 📈 验证统计

验证完成后会显示详细统计:

```
🔍 开始验证 50 个链接...
   超时设置: 10 秒
   并发数: 10

[1/50] ✅ https://raw.githubusercontent.com/...
[2/50] ✅ https://github.com/...
[3/50] 🔍 https://invalid.com/... (域名无法解析)
...
   进度: 10/50 (20.0%)

📊 验证完成:
   ✅ 有效链接: 35 个
   ❌ 无效链接: 15 个
   📈 有效率: 70.0%
   ⏱️  总耗时: 12.5s

📋 失败原因统计:
   ⏱️  超时: 5 个
   🔍 域名无法解析: 8 个
   ❌ HTTP 404: 2 个
```

## 🎨 使用场景

### 场景 1: 首次运行

**推荐配置**:

```env
VALIDATE_LINKS=false
```

**理由**:

- 收集尽可能多的订阅源
- 不确定哪些链接可用
- 先建立初始数据库

### 场景 2: 定期更新

**推荐配置**:

```env
VALIDATE_LINKS=true
LINK_VALIDATION_TIMEOUT=10000
LINK_VALIDATION_CONCURRENCY=10
```

**理由**:

- 确保 config.yaml 中只有可用链接
- 自动清理失效的订阅源
- 提高订阅质量
- 并发验证提高效率

### 场景 3: 快速清理

**推荐配置**:

```env
VALIDATE_LINKS=true
LINK_VALIDATION_TIMEOUT=5000
```

**理由**:

- 快速过滤掉响应慢的链接
- 节省验证时间
- 只保留响应快的订阅源

### 场景 4: 宽松验证

**推荐配置**:

```env
VALIDATE_LINKS=true
LINK_VALIDATION_TIMEOUT=20000
```

**理由**:

- 适用于网络较慢的环境
- 给服务器更多响应时间
- 减少误杀有效但响应慢的链接

## ⚡ 性能影响

### 验证时间估算

```
总验证时间 ≈ (链接数量 × 平均验证时间) + (链接数量 × 0.5秒)
```

- **平均验证时间**: 有效链接通常 1-3 秒,无效链接等待超时
- **延迟**: 每个链接之间有 0.5 秒延迟,避免请求过快

### 示例

50 个链接,10 秒超时:

- 最快: ~50 秒 (所有链接都有效且快速响应)
- 最慢: ~525 秒 (所有链接都超时)
- 平均: ~150-250 秒

## 🔧 技术实现

### LinkValidator 类

位置: [src/link-validator.ts](src/link-validator.ts)

**核心方法**:

1. **validateUrl(url: string)**: 验证单个链接
   - 使用 axios 发送 GET 请求
   - 设置超时时间
   - 检查返回内容
   - 分类错误类型

2. **validateLinks(links: SubscriptionLink[])**: 批量验证
   - 遍历所有链接
   - 显示进度和结果
   - 返回有效链接列表
   - 输出统计信息

### 集成点

位置: [src/collector.ts:85-88](src/collector.ts#L85-L88)

```typescript
// 如果启用了链接验证,验证所有链接
let linksToUpdate = this.aggregator.getAllLinks();

if (this.config.validateLinks && this.validator) {
  console.log('\n🔐 链接验证已启用\n');
  linksToUpdate = await this.validator.validateLinks(linksToUpdate);
}
```

## 📋 最佳实践

### 1. 渐进式启用

```bash
# 第1次: 不验证,收集所有链接
VALIDATE_LINKS=false npm run once

# 第2次: 启用验证,清理无效链接
VALIDATE_LINKS=true npm run once
```

### 2. 定时任务配置

```env
# 每天凌晨2点收集并验证
SCHEDULE_INTERVAL=0 2 * * *
VALIDATE_LINKS=true
LINK_VALIDATION_TIMEOUT=10000
```

### 3. 监控验证率

定期检查验证率,如果有效率持续低于 50%,考虑:

- 调整搜索关键字
- 提高 MIN_STARS 阈值
- 减少 MAX_DAYS_SINCE_UPDATE 天数

## ⚠️ 注意事项

### 1. 网络环境

- 验证需要访问外部网络
- 某些订阅源可能需要特殊网络环境
- 建议在网络稳定时进行验证

### 2. 服务器限制

- 某些服务器可能有访问频率限制
- 程序已内置 0.5 秒延迟
- 如遇问题可适当增加延迟

### 3. 超时设置

- 过短: 可能误杀响应慢但有效的链接
- 过长: 验证时间过长
- 建议: 5-15 秒

### 4. GitHub API 限制

验证功能不使用 GitHub API,不会影响 API 限制。

## 🐛 故障排查

### 问题: 所有链接都显示无效

**可能原因**:

- 本地网络问题
- 防火墙拦截
- 超时时间设置过短

**解决方案**:

1. 检查网络连接
2. 增加超时时间
3. 临时禁用验证

### 问题: 验证时间过长

**可能原因**:

- 链接数量太多
- 超时时间设置过长
- 网络响应慢

**解决方案**:

1. 减少 MAX_REPOSITORIES
2. 缩短 LINK_VALIDATION_TIMEOUT
3. 提高 MIN_STARS 过滤更多仓库

### 问题: 有效链接被误判为无效

**可能原因**:

- 订阅源需要特殊网络环境
- 临时网络波动
- 服务器限流

**解决方案**:

1. 增加超时时间
2. 稍后重试
3. 手动添加到 config.yaml

## 📚 相关文档

- [更新日志](更新日志.md#v120---2025-11-07) - v1.2.0 版本说明
- [README](README.md#-链接验证功能) - 总体说明
- [智能排序说明](智能排序说明.md) - 质量过滤机制
