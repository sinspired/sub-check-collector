# 启动脚本使用说明

## 📦 启动脚本

项目提供了跨平台的启动脚本,自动处理环境检查、依赖安装、项目构建等操作。

### Linux/macOS

使用 `start.sh`:

```bash
# 显示帮助信息
./start.sh help

# 立即执行一次收集任务
./start.sh once

# 启动定时任务
./start.sh schedule

# 启动定时任务并立即执行一次
./start.sh now
```

### Windows

使用 `start.bat`:

```cmd
REM 显示帮助信息
start.bat help

REM 立即执行一次收集任务
start.bat once

REM 启动定时任务
start.bat schedule

REM 启动定时任务并立即执行一次
start.bat now
```

## 🚀 启动脚本功能

启动脚本会自动执行以下操作:

### 1. 环境检查

- ✅ 检查 Node.js 是否已安装
- ✅ 显示 Node.js 版本信息

### 2. 依赖管理

- ✅ 检查 `node_modules` 是否存在
- ✅ 如未安装,自动运行 `npm install`
- ✅ 显示依赖安装状态

### 3. 配置文件

- ✅ 检查 `.env` 文件是否存在
- ✅ 如不存在,自动从 `.env.example` 复制
- ✅ 提示用户编辑配置文件

### 4. 项目构建

- ✅ 自动运行 `npm run build`
- ✅ 编译 TypeScript 代码
- ✅ 显示构建状态

### 5. 目录创建

- ✅ 自动创建 `output` 目录
- ✅ 自动创建 `logs` 目录

### 6. 应用启动

- ✅ 根据参数启动对应模式
- ✅ 显示启动信息和日志路径

## 📊 运行示例

### 首次运行

```bash
$ ./start.sh once

═══════════════════════════════════════════════════
   V2Ray/Clash 订阅链接自动收集器
═══════════════════════════════════════════════════

[信息] 模式: 立即执行一次

[信息] Node.js 版本: v20.10.0
[警告] 未找到依赖,正在安装...
[成功] 依赖安装完成
[警告] 未找到 .env 文件
[信息] 正在从 .env.example 创建 .env 文件...
[成功] .env 文件已创建,请编辑配置后重新运行

[警告] 请编辑 .env 文件配置参数,特别是 GITHUB_TOKEN
```

### 正常运行

```bash
$ ./start.sh once

═══════════════════════════════════════════════════
   V2Ray/Clash 订阅链接自动收集器
═══════════════════════════════════════════════════

[信息] 模式: 立即执行一次

[信息] Node.js 版本: v20.10.0
[信息] 依赖已安装
[信息] 配置文件: .env

[信息] 正在构建项目...
[成功] 构建完成

[信息] 输出目录: ./output
[信息] 日志目录: ./logs

[成功] 正在启动应用...

═══════════════════════════════════════════════════
   V2Ray/Clash 订阅链接自动收集器
═══════════════════════════════════════════════════

📝 日志目录: ./logs
📄 日志文件: ./logs/app-2025-11-07.log

🔥 手动执行一次收集任务

🚀 开始收集订阅链接...
```

## 📝 日志查看

使用 `view-logs.sh` 查看日志:

### Linux/macOS

```bash
# 显示最新日志
./view-logs.sh

# 实时跟踪日志
./view-logs.sh tail

# 列出所有日志文件
./view-logs.sh list

# 显示指定序号的日志
./view-logs.sh 1

# 显示帮助
./view-logs.sh help
```

### 使用示例

```bash
$ ./view-logs.sh list

═══════════════════════════════════════════════════
   日志查看工具
═══════════════════════════════════════════════════

[信息] 可用的日志文件:

  [1] app-2025-11-07.log (12K)
  [2] app-2025-11-06.log (8.5K)
  [3] app-2025-11-05.log (15K)

使用方法: ./view-logs.sh <文件序号>
```

```bash
$ ./view-logs.sh tail

═══════════════════════════════════════════════════
   日志查看工具
═══════════════════════════════════════════════════

[信息] 实时跟踪日志: app-2025-11-07.log
[提示] 按 Ctrl+C 退出

[2025-11-07 10:30:15] [INFO] 收集流程启动
  数据: {
    "searchKeywords": ["free", "v2ray"],
    "maxRepositories": 30,
    "minStars": 5,
    "maxDaysSinceUpdate": 60,
    "validateLinks": true
  }
...
```

## 🔧 故障排查

### 问题: 提示 "未找到 Node.js"

**解决方案:**

1. 安装 Node.js (建议 v16 或更高版本)
2. 重启终端
3. 重新运行脚本

### 问题: 提示 "构建失败"

**解决方案:**

1. 检查 TypeScript 代码是否有语法错误
2. 删除 `node_modules` 和 `package-lock.json`
3. 重新运行 `npm install`
4. 再次尝试构建

### 问题: Windows 上脚本无法执行

**解决方案:**

1. 使用管理员权限运行命令提示符
2. 确保系统支持批处理文件
3. 尝试手动运行: `npm run build && npm run once`

### 问题: 脚本执行权限不足 (Linux/macOS)

**解决方案:**

```bash
chmod +x start.sh
chmod +x view-logs.sh
```

## 📋 快速参考

### start.sh / start.bat

| 参数 | 说明 |
|------|------|
| (无) | 启动定时任务 |
| `once` | 立即执行一次 |
| `schedule` | 启动定时任务 |
| `now` | 定时任务 + 立即执行 |
| `help` | 显示帮助信息 |

### view-logs.sh

| 参数 | 说明 |
|------|------|
| (无) | 显示最新日志 |
| `latest` | 显示最新日志 |
| `tail` | 实时跟踪日志 |
| `list` | 列出所有日志 |
| `<序号>` | 显示指定日志 |
| `help` | 显示帮助信息 |

## 💡 使用建议

### 1. 首次使用

```bash
# 1. 运行脚本,生成配置文件
./start.sh once

# 2. 编辑 .env 文件
vim .env  # 或使用其他编辑器

# 3. 重新运行
./start.sh once
```

### 2. 日常使用

```bash
# 立即收集一次
./start.sh once

# 查看日志
./view-logs.sh
```

### 3. 服务器部署

```bash
# 使用 nohup 后台运行
nohup ./start.sh schedule > /dev/null 2>&1 &

# 或使用 screen/tmux
screen -S v2ray-collector
./start.sh schedule
# Ctrl+A, D 离开
```

### 4. 调试问题

```bash
# 启用详细日志
export DEBUG=*

# 运行并查看日志
./start.sh once
./view-logs.sh tail
```

## 🎯 高级用法

### 自定义启动参数

可以通过环境变量覆盖配置:

```bash
# 临时修改配置
MIN_STARS=10 MAX_REPOSITORIES=50 ./start.sh once

# 或修改 .env 文件
```

### 配合 cron 定时任务

```bash
# 编辑 crontab
crontab -e

# 添加定时任务 (每天凌晨2点)
0 2 * * * cd /path/to/project && ./start.sh once >> /var/log/v2ray-collector.log 2>&1
```

### Docker 部署 (未来功能)

```bash
# 构建镜像
docker build -t v2ray-collector .

# 运行容器
docker run -d \
  -v $(pwd)/output:/app/output \
  -v $(pwd)/logs:/app/logs \
  --env-file .env \
  v2ray-collector
```
